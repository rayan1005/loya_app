name: iOS TestFlight

on:
  workflow_dispatch:

jobs:
  build-and-upload:
    runs-on: macos-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: stable
          cache: true

      - name: Flutter pub get
        run: flutter pub get

      - name: Set up keychain and provisioning
        env:
          APPLE_CERT_BASE64: ${{ secrets.APPLE_CERT_BASE64 }}
          APPLE_CERT_PASSWORD: ${{ secrets.APPLE_CERT_PASSWORD }}
          APPLE_PROFILE_BASE64: ${{ secrets.APPLE_PROFILE_BASE64 }}
          KEYCHAIN_PASSWORD: ${{ secrets.APPLE_KEYCHAIN_PASSWORD }}
        run: |
          security create-keychain -p "$KEYCHAIN_PASSWORD" build.keychain
          security default-keychain -s build.keychain
          security unlock-keychain -p "$KEYCHAIN_PASSWORD" build.keychain

          echo "$APPLE_CERT_BASE64" | base64 --decode > /tmp/dist.p12
          security import /tmp/dist.p12 -k build.keychain -P "$APPLE_CERT_PASSWORD" -A
          security set-key-partition-list -S apple-tool:,apple: -s -k "$KEYCHAIN_PASSWORD" build.keychain

          mkdir -p ~/Library/MobileDevice/Provisioning\ Profiles
          echo "$APPLE_PROFILE_BASE64" | base64 --decode > ~/Library/MobileDevice/Provisioning\ Profiles/app.mobileprovision

          PROFILE_NAME=$(security cms -D -i ~/Library/MobileDevice/Provisioning\ Profiles/app.mobileprovision | /usr/libexec/PlistBuddy -c "Print :Name" /dev/stdin)
          cat > /tmp/ExportOptions.plist <<EOF
          <?xml version="1.0" encoding="UTF-8"?>
          <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
          <plist version="1.0">
          <dict>
            <key>method</key><string>app-store</string>
            <key>signingStyle</key><string>manual</string>
            <key>provisioningProfiles</key>
            <dict>
              <key>com.mycompany.loya</key><string>${PROFILE_NAME}</string>
            </dict>
            <key>teamID</key><string>${{ secrets.APPLE_TEAM_ID }}</string>
          </dict>
          </plist>
          EOF

      - name: Build IPA (manual signing)
        run: flutter build ipa --release --export-options-plist=/tmp/ExportOptions.plist

      - name: Install fastlane
        run: sudo gem install fastlane -NV

      - name: Prepare App Store Connect API key
        env:
          APP_STORE_CONNECT_KEY_BASE64: ${{ secrets.APP_STORE_CONNECT_KEY_BASE64 }}
          APP_STORE_CONNECT_KEY_ID: ${{ secrets.APP_STORE_CONNECT_KEY_ID }}
          APP_STORE_CONNECT_ISSUER_ID: ${{ secrets.APP_STORE_CONNECT_ISSUER_ID }}
        run: |
          echo "$APP_STORE_CONNECT_KEY_BASE64" | base64 --decode > /tmp/AuthKey.p8
          KEY_CONTENT=$(cat /tmp/AuthKey.p8 | sed 's/$/\\n/' | tr -d '\n')
          cat > /tmp/api_key.json <<EOF
          {
            "key_id": "${APP_STORE_CONNECT_KEY_ID}",
            "issuer_id": "${APP_STORE_CONNECT_ISSUER_ID}",
            "key": "${KEY_CONTENT}",
            "in_house": false
          }
          EOF

      - name: Upload to TestFlight
        run: |
          fastlane pilot upload \
            --api_key_path /tmp/api_key.json \
            --ipa build/ios/ipa/Runner.ipa \
            --skip_waiting_for_build_processing true
