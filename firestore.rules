rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    
    // Helper functions
    function isAuthenticated() {
      return request.auth != null;
    }
    
    function isOwner(ownerId) {
      return isAuthenticated() && request.auth.uid == ownerId;
    }
    
    function getBusiness(businessId) {
      return get(/databases/$(database)/documents/businesses/$(businessId)).data;
    }
    
    function isBusinessOwner(businessId) {
      return isAuthenticated() && getBusiness(businessId).ownerId == request.auth.uid;
    }
    
    // Businesses collection
    match /businesses/{businessId} {
      // Allow public read of basic info (for customer join page) 
      // Or authenticated owner for full access
      allow get: if true;
      allow list: if isAuthenticated() && isOwner(resource.data.ownerId);
      
      // Allow create for authenticated users
      allow create: if isAuthenticated() 
        && request.resource.data.ownerId == request.auth.uid;
      
      // Allow update if user is the owner
      allow update: if isOwner(resource.data.ownerId)
        && request.resource.data.ownerId == resource.data.ownerId; // Can't change owner
      
      // No delete allowed (soft delete instead)
      allow delete: if false;
      
      // Automation rules subcollection
      match /automationRules/{ruleId} {
        // Allow read/list for business owner
        allow read, list: if isBusinessOwner(businessId);
        
        // Allow create for business owner
        allow create: if isBusinessOwner(businessId);
        
        // Allow update for business owner
        allow update: if isBusinessOwner(businessId);
        
        // Allow delete for business owner
        allow delete: if isBusinessOwner(businessId);
      }
    }
    
    // Programs collection
    match /programs/{programId} {
      // Allow public read of individual programs (for customer join page)
      allow get: if true;
      
      // Allow list for authenticated users (filtered by businessId in query)
      allow list: if isAuthenticated();
      
      // Allow create if user owns the business
      allow create: if isAuthenticated()
        && isBusinessOwner(request.resource.data.businessId);
      
      // Allow update if user owns the business
      allow update: if isBusinessOwner(resource.data.businessId);
      
      // Allow delete if user owns the business
      allow delete: if isBusinessOwner(resource.data.businessId);
    }
    
    // Customers collection
    match /customers/{customerId} {
      // Allow read for the customer themselves OR business owner
      allow get: if isAuthenticated() && (request.auth.uid == customerId || true);
      
      // Allow list/query for authenticated users OR public join page queries
      allow list: if true;
      
      // Allow create/update for authenticated users (customers can create their own profile)
      allow create: if isAuthenticated();
      allow update: if isAuthenticated() && request.auth.uid == customerId;
      
      // No delete allowed
      allow delete: if false;
    }
    
    // Program Customers collection (linking customers to programs - old HTML page)
    match /program_customers/{linkId} {
      // Allow read for authenticated users
      allow read, list: if isAuthenticated();
      
      // Allow create for authenticated users (customers joining programs)
      allow create: if isAuthenticated();
      
      // Allow update for authenticated users
      allow update: if isAuthenticated();
      
      // No delete allowed
      allow delete: if false;
    }
    
    // Customer progress collection (snake_case collection name)
    match /customer_progress/{progressId} {
      // Allow read/list for authenticated users OR public for join page
      allow read, list: if true;
      
      // Allow create for business owners OR public (for join page)
      allow create: if true;
      
      // Allow update if user owns the business
      allow update: if isBusinessOwner(resource.data.businessId);
      
      // No delete allowed
      allow delete: if false;
    }
    
    // Activity collection (activity_log)
    match /activity/{activityId} {
      // Allow read/list for authenticated users
      allow read, list: if isAuthenticated();
      
      // Allow create if user owns the business
      allow create: if isAuthenticated()
        && isBusinessOwner(request.resource.data.businessId);
      
      // No update or delete allowed (logs are immutable)
      allow update: if false;
      allow delete: if false;
    }
    
    // Activity log collection (alternate name used in some screens)
    match /activity_log/{activityId} {
      // Allow read/list for authenticated users
      allow read, list: if isAuthenticated();
      
      // Allow create for authenticated users
      allow create: if isAuthenticated();
      
      // No update or delete allowed (logs are immutable)
      allow update: if false;
      allow delete: if false;
    }
    
    // Messages collection (push notifications)
    match /messages/{messageId} {
      // Allow read/list for authenticated users
      allow read, list: if isAuthenticated();
      
      // Allow create for authenticated users
      allow create: if isAuthenticated();
      
      // Allow update if user owns the business
      allow update: if isAuthenticated();
      
      // No delete allowed
      allow delete: if false;
    }
    
    // Locations collection (business branches)
    match /locations/{locationId} {
      // Allow read for authenticated users
      allow read, list: if isAuthenticated();
      
      // Allow create for authenticated users who own the business
      allow create: if isAuthenticated();
      
      // Allow update for authenticated users
      allow update: if isAuthenticated();
      
      // Allow delete for authenticated users
      allow delete: if isAuthenticated();
    }
    
    // Wallet passes collection (Apple Wallet passes)
    match /wallet_passes/{passId} {
      // Allow read for authenticated users
      allow read, list: if isAuthenticated();
      
      // Allow create (typically from backend, but allow for flexibility)
      allow create: if isAuthenticated();
      
      // Allow update for authenticated users (stamper needs to update points)
      allow update: if isAuthenticated();
      
      // No delete allowed
      allow delete: if false;
    }
    
    // Device registrations collection (for Apple Wallet push notifications)
    match /device_registrations/{deviceId} {
      // Allow read/write for authenticated users and backend
      allow read, write: if true;
    }
    
    // Users collection (for additional user profile data)
    match /users/{userId} {
      allow read, write: if isOwner(userId);
    }
    
    // Subscriptions collection (for billing/plans)
    match /subscriptions/{businessId} {
      // Allow read for authenticated users who own this subscription
      allow read: if isAuthenticated() 
        && resource.data.userId == request.auth.uid;
      
      // Allow create for authenticated users (initial subscription)
      allow create: if isAuthenticated() 
        && request.resource.data.userId == request.auth.uid;
      
      // Allow update for owner (to update usage, etc.)
      allow update: if isAuthenticated() 
        && resource.data.userId == request.auth.uid;
      
      // No delete allowed
      allow delete: if false;
    }
    
    // Default deny all
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
